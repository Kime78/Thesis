worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream upload_backends {
        server file_receiver1:8000;
        server file_receiver2:8000;
        server file_receiver3:8000;
    }

    server {
        listen 80; # NGINX listens on port 80 inside its container
        server_name localhost; # Or your domain if mapping to a real domain

        # Increase max body size for uploads (e.g., 100MB)
        client_max_body_size 100M;

        # Location block for the /upload path
        location /upload {
            # Reverse Proxy Directive: Send requests to the 'upload_backends' group
            proxy_pass http://upload_backends;

            # Standard headers for reverse proxying
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Adjust timeouts for potentially long upload processes
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Prevent NGINX from buffering large files in memory too much,
            # allowing it to stream directly to the backend.
            proxy_request_buffering off;
        }

        # Catch-all for other paths (e.g., if you had a frontend here)
        location / {
            return 200 "Hello from NGINX! Use /upload to test.";
            # Or serve static files:
            # root /usr/share/nginx/html;
            # index index.html;
            # try_files $uri $uri/ =404;
        }
    }
}